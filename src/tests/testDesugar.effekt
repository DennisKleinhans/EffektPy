import test
import src/lib/parser/surfaceAst
import src/lib/desugar/sugar
import src/lib/desugar/coreAst
import src/lib/lexer/tokens
import src/lib/utils/errors

def main() = mainSuite("desugar") {
  
  test("desugar comparison chain") {
    
    // x < 10 >= 5
    val chain = surfaceAst::CompareChain(
      surfaceAst::Variable("x"),
      [
        (TokenKind::Less(), surfaceAst::IntLiteral(10)),
        (TokenKind::GreaterEqual(), surfaceAst::IntLiteral(5))
      ]
    )

    with on[DesugarError].panic
    with on[ParseError].panic
    val desugared = desugarExpr(chain)

    val expected = coreAst::AndExpr(
      coreAst::Lt(coreAst::Variable("x"), coreAst::IntLiteral(10)),
      coreAst::GtE(coreAst::IntLiteral(10), coreAst::IntLiteral(5))
    )

    assertEqual(desugared, expected)
  }

  test("desugar compound assignment") {
    // x += 5
    val stmt = surfaceAst::CompoundAssignStmt("x", TokenKind::PlusAssign(), surfaceAst::IntLiteral(5))

    with on[DesugarError].panic
    with on[ParseError].panic
    val desugared = desugarStmt(stmt)

    val expected = coreAst::AssignStmt(
      "x",
      coreAst::AddExpr(
        coreAst::Variable("x"),
        coreAst::IntLiteral(5)
      )
    )

    assertEqual(desugared, expected)
  }

  test("desugar unary minus") {
    // -x
    val expr = surfaceAst::UnaryMinus(surfaceAst::Variable("x"))

    with on[DesugarError].panic
    with on[ParseError].panic
    val desugared = desugarExpr(expr)

    val expected = coreAst::SubExpr(
      coreAst::IntLiteral(0),
      coreAst::Variable("x")
    )

    assertEqual(desugared, expected)
  }

  test("desugar whole program") {
    // val a = 10
    // var b = 20
    // b = a + 5
    // b += 10
    // b > 15 <= 30
    val program: surfaceAst::Program = [
      surfaceAst::ValDeclaration("a", None(), surfaceAst::IntLiteral(10)),
      surfaceAst::VarDeclaration("b", None(), surfaceAst::IntLiteral(20)),
      surfaceAst::CompoundAssignStmt("b", TokenKind::PlusAssign(), surfaceAst::IntLiteral(10)),
      surfaceAst::AssignStmt("b", surfaceAst::AddExpr(surfaceAst::Variable("a"), surfaceAst::IntLiteral(5))),
      surfaceAst::ExprStmt(
        surfaceAst::CompareChain(
          surfaceAst::Variable("b"),
          [
            (TokenKind::Greater(), surfaceAst::IntLiteral(15)),
            (TokenKind::LessEqual(), surfaceAst::IntLiteral(30))
          ]
        )
      )
    ]

    with on[DesugarError].panic
    with on[ParseError].panic
    val desugaredProgram = desugarProgram(program)

    val expectedProgram: coreAst::Program = [
      coreAst::ValDeclaration("a", None(), coreAst::IntLiteral(10)),
      coreAst::VarDeclaration("b", None(), coreAst::IntLiteral(20)),
      coreAst::AssignStmt("b", coreAst::AddExpr(coreAst::Variable("b"), coreAst::IntLiteral(10))),
      coreAst::AssignStmt("b", coreAst::AddExpr(coreAst::Variable("a"), coreAst::IntLiteral(5))),
      coreAst::ExprStmt(
        coreAst::AndExpr(
          coreAst::Gt(coreAst::Variable("b"), coreAst::IntLiteral(15)),
          coreAst::LtE(coreAst::IntLiteral(15), coreAst::IntLiteral(30))
        )
      )
    ]

    assertEqual(desugaredProgram, expectedProgram)
  }

}