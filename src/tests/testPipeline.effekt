module src/tests/testPipeline

import test
import src/lib/runner/runPipeline
import src/lib/utils/testUtils
import src/lib/utils/types
import src/lib/utils/helpers

def main() = mainSuite("pipeline") {

  test("simple arithmetic") {
    val result = runPipeline("val x = 10 + 20 * 3\nx")
    assertTrue(result.equal(VInt(70)))
  }

  test("compare expressions") {
    val result = runPipeline("val x = 10 < 20\nx")
    assertTrue(result.equal(VBool(true)))
  }

  test("compare chain expressions") {
    val result = runPipeline("val x = 10 < 20 < 30\nx")
    assertTrue(result.equal(VBool(true)))
  }

  test("if expression"){
    val result = runPipeline("val x = if 10 < 20 then 1 else 2\nx")
    assertTrue(result.equal(VInt(1)))
  }

  test("if expression without assignment") {
    val result = runPipeline("if 10 < 20 then 1 else 2")
    assertTrue(result.equal(VInt(1)))
  }

  test("nested if expression"){
    val result = runPipeline("val x = if 10 < 20 then (if 5 > 3 then 2 else 3) else 4\nx")
    assertTrue(result.equal(VInt(2)))
  }

  test("if statement without else") {
    val result = runPipeline("""
      if (10 < 5) {
        val x = 2
        x
      }
    """)
    assertTrue(result.equal(VUnit()))
  }

  test("if statement with else") {
    val result = runPipeline("""
      if (10 < 5) {
        val x = 2
        x
      } else {
        val x = 5
        x
      }
    """)
    assertTrue(result.equal(VInt(5)))
  }

  test("nested if statements") {
    val result = runPipeline("""
      if (10 < 20) {
        if (true) {
          val x = 2
          x
        }
      } else {
        val x = 5
        x
      }
    """)
    assertTrue(result.equal(VInt(2)))
  }

  test("variable assignment and update") {
    val result = runPipeline("""
      var x = 10
      x = x + 5
      x
    """)
    assertTrue(result.equal(VInt(15)))
  }

  test("compund assignment plus") {
    val result = runPipeline("""
      var x = 10
      x += 1
      x
    """)
    assertTrue(result.equal(VInt(11)))
  }

  test("compound assignment minus") {
    val result = runPipeline("""
      var x = 10
      x -= 2
      x
    """)
    assertTrue(result.equal(VInt(8)))
  }

  test("shadowing in if blocks") {
    val result = runPipeline("""
      var x = 10
      if (true) {
        val x = 20
        x
      } else {
        val x = 30
        x
      }
    """)
    assertTrue(result.equal(VInt(20)))
  }

  test("shadowing in nested if blocks") {
    val result = runPipeline("""
      var x = 10
      if (true) {
        val x = 20
        if (false) {
          val x = 40
          x
        } else {
          val x = 30
          x
        }
      } else {
        val x = 50
        x
      }
    """)
    assertTrue(result.equal(VInt(30)))
  }

  test("complex program: nested ifs and assignments") {
    val result = runPipeline("""
      var x = 5
      var y = 10
      if (x < y) {
        x = x + 15
        if (y > 5) {
          y += 20
        } else {
          y += 30
        }
      } else {
        x += 25
      }
      x + y
    """)
    assertTrue(result.equal(VInt(50)))
  }

  test("while loop") {
    val result = runPipeline("""
      var x = 0
      while (x < 5) {
        x += 1
      }
      x
    """)
    assertTrue(result.equal(VInt(5)))
  }

  test("while loop with if statement inside") {
    val result = runPipeline("""
      var x = 0
      var y = 0
      while (x < 5) {
        if (x == 2) {
          y += 3
        }
        x += 1
      }
      y + x
    """)
    assertTrue(result.equal(VInt(8)))
  }

  test("while loop with nested if statements") {
    val result = runPipeline("""
      var x = 0
      var y = 0
      while (x < 5) {
        if (x < 3) {
          if (x == 1) {
            y += 10
          } else {
            y += 1
          }
        }
        x += 1
      }
      y + x
    """)
    assertTrue(result.equal(VInt(17)))
  }

  test("full feature program: annotations, chains, shadowing, loops") {
    val result = runPipeline("""
      val base: Int = 3 * 2 + 1 
      var acc: Int = base 
      var counter = 0
      var guard: Bool = true
      val chainOk: Bool = 0 < base < 10

      while (counter < 5) {
        if (counter == 2 or not chainOk) {
          val shadow = acc
          acc = shadow + counter
        } else {
          var bump = counter * 2
          acc = acc + bump
        }
        counter += 1
      }

      while (guard and (counter >= 5)) {
        if (0 < acc < 100) {
          acc -= 3
          guard = false
        } else {
          acc += 1
        }
      }

      val finalVal = if guard then -acc else acc / 2
      finalVal + acc
    """)
    assertTrue(result.equal(VInt(33)))
  }

  test("full feature program: break and continue in loops") {
    val result = runPipeline("""
      var x: Int = 0
      var sum: Int = 0
      var multiplier: Int = 1
      val limit: Bool = 10 < 20

      while (x < 10) {
        if (x == 3) {
          x += 1
          continue
        }

        if (x == 7 and limit) {
          break
        }

        if (x > 0 and x < 6) {
          sum = sum + x
          multiplier = multiplier * 2
        }

        x += 1
      }

      var result: Int = 0
      var iter: Int = 0
      while (iter < 3) {
        if (iter == 1) {
          val skipped = 100
          iter += 1
          continue
        }

        if (iter == 2) {
          result = result + 50
          break
        }

        result = result + 10
        iter += 1
      }

      sum + result + multiplier
    """)
    assertTrue(result.equal(VInt(88)))
  }
}